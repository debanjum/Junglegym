var isNode=!0;try{isNode=require}catch(e$$12){isNode=!1}var io,request,LAST_THING_NAME="last-thing.dat",DWEET_SERVER="https://dweet.io",STRICT_SSL=!0,REQUEST_TIMEOUT=5E3,lastThing;
if(isNode){if(io=require("socket.io-client"),request=require("request"),require("fs").existsSync(LAST_THING_NAME))try{lastThing=require("fs").readFileSync(LAST_THING_NAME).toString()}catch(e$$13){}}else request=function(k,q){var m=k.url+(k.url.indexOf("?")+1?"&":"?"),n=document.getElementsByTagName("head")[0],f=[],d="";for(d in k.json)f.push(d+"="+encodeURIComponent(k.json[d]));for(var c="callback",d=0;window.dweetCallback[c+d];)d++;c+=d;window.dweetCallback[c]=function(c){q(null,c,c)};f.push("callback=dweetCallback."+
c);f.push("_="+Date.now());m+=f.join("&");dweet_script_loader(m,function(d){n.removeChild(d);window.dweetCallback[c]=void 0;delete window.dweetCallback[c]})},window.dweetCallback={},function(){var k=document.getElementsByTagName("script")[0],q=k.parentNode,m=/ded|co/,n=function(f,d){var c=document.createElement("script");c.onload=c.onreadystatechange=function(){if(!this.readyState||m.test(this.readyState))c.onload=c.onreadystatechange=null,d&&d(c),c=null};c.async=!0;c.src=f;q.insertBefore(c,k)};window.dweet_script_loader=
function(f,d){if("string"==typeof f)n(f,d);else{var c=f.shift();n(c,function(c){f.length?window.dweet_script_loader(f,d):d&&d(c)})}}}();
var dweetioClient=function(){function k(a){a.created&&(a.created=new Date(a.created));return a}function q(a){if(a instanceof Array)for(var b=0;b<a.length;b++)k(a[b]);else k(a);return a}function m(a){var b;try{b="string"==typeof a||a instanceof String?JSON.parse(a):a}catch(e){}return b}function n(a){var b;(a=m(a))?"failed"==a["this"]&&(b=Error(a.because)):b=Error("server returned an invalid response");return b}function f(a){return"function"===typeof a}function d(a,b){return b?a+(a.indexOf("?")+1?"&":
"?")+"key="+encodeURIComponent(b):a}function c(a,b,e){e=m(e);a||(a=n(e));e&&e["with"]?b&&b(a,q(e["with"])):b&&b("no response from server",void 0)}var h=this,g,l={},r=lastThing;h.set_server=function(a,b){DWEET_SERVER=a;STRICT_SSL=b;isNode&&(b?require("https").globalAgent.options.rejectUnauthorized=!0:require("https").globalAgent.options.rejectUnauthorized=!1)};h.dweet=function(a,b){r?h.dweet_for(r,a,b):request({url:DWEET_SERVER+"/dweet",jar:!0,method:"POST",followAllRedirects:!0,timeout:REQUEST_TIMEOUT,
strictSSL:STRICT_SSL,json:a},function(a,p,d){p=m(d);p["with"]&&p["with"].thing!=r&&(r=p["with"].thing,isNode&&require("fs").writeFile(LAST_THING_NAME,r));c(a,b,p)})};h.dweet_for=function(a,b,e,p){f(e)&&(p=e,e=null);request({url:d(DWEET_SERVER+"/dweet/for/"+a,e),jar:!0,method:"POST",followAllRedirects:!0,timeout:REQUEST_TIMEOUT,strictSSL:STRICT_SSL,json:b},function(a,b,e){c(a,p,e)})};h.get_latest_dweet_for=function(a,b,e){f(b)&&(e=b,b=null);request({url:d(DWEET_SERVER+"/get/latest/dweet/for/"+a,b),
jar:!0,timeout:REQUEST_TIMEOUT,strictSSL:STRICT_SSL},function(a,b,d){c(a,e,d)})};h.get_all_dweets_for=function(a,b,e){f(b)&&(e=b,b=null);request({url:d(DWEET_SERVER+"/get/dweets/for/"+a,b),jar:!0,timeout:REQUEST_TIMEOUT,strictSSL:STRICT_SSL},function(a,b,d){c(a,e,d)})};h.listen_for=function(a,b,e){function c(){g=io.connect(DWEET_SERVER+"/stream");g.on("connect",function(){for(var a in l)g.emit("subscribe",{thing:a,key:b})});g.on("new_dweet",function(a){if(l[a.thing]){q(a);for(var b=l[a.thing],c=0;c<
b.length;c++)b[c](a)}})}f(b)&&(e=b,b=null);l[a]||(l[a]=[]);-1==l[a].indexOf(e)&&l[a].push(e);g?g&&g.socket.connected&&g.emit("subscribe",{thing:a}):isNode?c():dweet_script_loader([DWEET_SERVER+"/socket.io/socket.io.js"],function(){c()})};h.stop_listening=function(){l={};g&&(g.disconnect(),g=void 0)};h.stop_listening_for=function(a){l[a]=void 0;delete l[a];g&&g.emit("unsubscribe",{thing:a})};h.lock=function(a,b,c,d){request({url:DWEET_SERVER+"/lock/"+a+"?lock="+b+"&key="+c,jar:!0,timeout:REQUEST_TIMEOUT,
strictSSL:STRICT_SSL},function(a,b,c){a||(a=n(c));d&&d(a)})};h.unlock=function(a,b,c){request({url:d(DWEET_SERVER+"/unlock/"+a,b),jar:!0,timeout:REQUEST_TIMEOUT,strictSSL:STRICT_SSL},function(a,b,d){a||(a=n(d));c&&c(a)})};h.remove_lock=function(a,b,c){request({url:DWEET_SERVER+"/remove/lock/"+a+"?key="+b,jar:!0,timeout:REQUEST_TIMEOUT,strictSSL:STRICT_SSL},function(a,b,d){a||(a=n(d));c&&c(a)})}};isNode?module.exports=dweetioClient:window.dweetio=new dweetioClient;
